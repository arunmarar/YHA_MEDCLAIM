sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessagePopover","sap/m/MessageItem","sap/m/MessageBox","sap/m/MessageToast","../model/formatter","sap/m/Dialog"],function(e,t,a,r,i,s,o){"use strict";var n;var l;var g=null;var d=null;var p=new a({type:"{type}",title:"{Message}",description:"{Message}"});var v=new t({items:{path:"/",template:p},activeTitlePress:function(){i.show("Active title is pressed")}});return e.extend("Gail.Medical_Claim.controller.Review",{formatter:s,onInit:function(){this._TCDialog=null;this.getOwnerComponent().getRouter().getRoute("review").attachPatternMatched(this._onReviewMatched,this)},bindTnCPDF:function(e){var t=e.results[0].Fdata;var a=this.getOwnerComponent().getModel("TnC");var r={Source:t};a.setData(r)},_onReviewMatched:function(e){this.getView().byId("errorBtn").setVisible(false);this.getView().getModel("appView").setProperty("/layout","OneColumn");var t=this.getOwnerComponent().getModel("RouteModel");t.setProperty("/split",false);t.setProperty("/normal",true);var a=this.getOwnerComponent().getModel("detailMasterModel");var r=a.getData().length;l=0;for(var i=0;i<r;i++){var s=a.getObject("/"+i).Rqamt;s=parseFloat(s);l=l+s}this.getView().byId("panel2").setHeaderText("Claims Items ("+r+")");this.getView().byId("rTotalAmt").setText("Rs."+l);var o=this.getOwnerComponent().getModel("buttonsModel");var n=o.getProperty("/process");var g=o.getProperty("/prevPdf");var d=o.getProperty("/prevAppPdf");if(n=="Display"){if(g==false&d==false){this.getView().byId("panelPdf2").setVisible(false)}else if(g==false&d==true){this.getView().byId("panelPdf2").setVisible(true);this.getView().byId("pdfToolbar2").setVisible(false);this.getView().byId("pdfApprovalToolbar2").setVisible(true)}else if(g==true&d==false){this.getView().byId("panelPdf2").setVisible(true);this.getView().byId("pdfToolbar2").setVisible(true);this.getView().byId("pdfApprovalToolbar2").setVisible(false)}else{this.getView().byId("panelPdf2").setVisible(true);this.getView().byId("pdfToolbar2").setVisible(true);this.getView().byId("pdfApprovalToolbar2").setVisible(true)}}else{this.getView().byId("panelPdf2").setVisible(false)}var p=this.getOwnerComponent().getModel("FileReaderModel");var v=p.getProperty("/size");var c=o.getProperty("/filesize");var u=o.getProperty("/prevPdf");var h=this.getOwnerComponent().getModel("OriginalPdfFiles").getProperty("/PDFFiles");this.overallFileSize=0;if(h){for(var i=0;i<h.length;i++){this.overallFileSize=this.overallFileSize+h[i].size}}if(v>.01){this.overallFileSize=this.overallFileSize+v}if(u===true){if(c){c=parseFloat(c);this.overallFileSize=this.overallFileSize+c}}this.overallFileSize=this.overallFileSize.toPrecision(3);this.getView().byId("rFilesize").setText(this.overallFileSize+" MB ");sap.ui.core.BusyIndicator.hide()},onDisplayPDF2:function(){sap.ui.core.BusyIndicator.show(0);var e=this.getOwnerComponent().getModel("buttonsModel");var t=e.getProperty("/process");var a=e.getProperty("/claimId");if(t=="Edit"||t=="Display"){var r=this.getOwnerComponent().getModel("InitialModel");var s=this;r.read("/CLAIMS_DETAILSSet('"+a+"')",{urlParameters:{$expand:"TOAttach"},success:function(e){s.bindPDF(e)},error:function(e){sap.ui.core.BusyIndicator.hide();i.show("Error Connecting odata service to backend")}})}},bindPDF:function(e){var t=e.TOAttach.results.length;var a=this;for(var r=0;r<t;r++){if(e.TOAttach.results[r].Fname==="Medical Reimbursement.PDF"){var i=e.TOAttach.results[r].Fdata;var s=e.TOAttach.results[r].Fdata.length;var o=s/(1024*1024);o=o.toPrecision(3)}}a.loadPdfonDevice(i,o)},loadPdfonDevice:function(e,t){sap.ui.core.BusyIndicator.hide();if(sap.ui.Device.system.phone){var a=atob(e);var r=new Uint8Array(a.length);for(var i=0;i<a.length;i++){r[i]=a.charCodeAt(i)}var s=new Blob([r.buffer],{type:"application/pdf"});var o=URL.createObjectURL(s);jQuery.sap.addUrlWhitelist("blob");if(sap.ui.Device.os.android){parent.window.open(o)}else{window.open(o)}}else{if(t>1.5){var a=atob(e);var r=new Uint8Array(a.length);for(var i=0;i<a.length;i++){r[i]=a.charCodeAt(i)}var s=new Blob([r.buffer],{type:"application/pdf"});var o=URL.createObjectURL(s);jQuery.sap.addUrlWhitelist("blob");window.open(o)}else{var n=new sap.ui.core.HTML;n.setContent("<iframe src="+"data:application/pdf;base64,"+e+" width='900' height='800'></iframe>");var l=this;if(!this.draggableDialog){this.draggableDialog=new sap.m.Dialog({title:"Preview",contentWidth:"900px",contentHeight:"800px",draggable:true,verticalScrolling:false,endButton:new sap.m.Button({text:"Close",type:"Emphasized",press:function(){this.draggableDialog.close()}.bind(this)})});this.getView().addDependent(this.draggableDialog)}var g=this.draggableDialog.getContent();for(var i=0;i<g.length;i++){this.draggableDialog.removeContent(i)}this.draggableDialog.addContent(n);this.draggableDialog.open()}}},onDisplayApprovalPDF:function(){sap.ui.core.BusyIndicator.show(0);var e=this.getOwnerComponent().getModel("buttonsModel");var t=e.getProperty("/process");var a=e.getProperty("/claimId");if(t=="Edit"||t=="Display"){var r=this.getOwnerComponent().getModel("InitialModel");var s=this;r.read("/CLAIMS_DETAILSSet('"+a+"')",{urlParameters:{$expand:"TOAttach"},success:function(e){s.bindApprovalPDF(e)},error:function(e){sap.ui.core.BusyIndicator.hide();i.show("Error Connecting odata service to backend")}})}},bindApprovalPDF:function(e){var t=e.TOAttach.results.length;var a=this;for(var r=0;r<t;r++){if(e.TOAttach.results[r].Fname==="Approval.PDF"){var i=e.TOAttach.results[r].Fdata;var s=e.TOAttach.results[r].Fdata.length;var o=s/(1024*1024);o=o.toPrecision(3)}}a.loadPdfonDevice(i,o)},onNavBack:function(){var e=this.getOwnerComponent().getModel("buttonsModel");e.setProperty("/uploadClear",false);history.go(-1)},onDisplayPDF:function(){var e=this.getOwnerComponent().getModel("FileReaderModel");var t=e.getProperty("/oPDF");t.output("dataurlnewwindow")},onDownloadPDF:function(){var e=this.getOwnerComponent().getModel("FileReaderModel");var t=e.getProperty("/oPDF");t.save("ExpenseReport.pdf")},navtoInitial:function(){var e=this.getOwnerComponent().getModel("InitialModel");e.refresh();this.getOwnerComponent().getRouter().navTo("initial")},onSaveDraft:function(){var e=this.getOwnerComponent().getModel("empFamDetails").getData();sap.ui.core.BusyIndicator.show(0);var t;var a=this.getOwnerComponent().getModel("detailMasterModel").getData();for(var r=0;r<a.length;r++){var i=e.filter(e=>e.TEXT.includes(a[r].Fcnam));if(i.length>0){var s=new Date((Number(i[0].FGBDT.substring(0,4))+30).toString()+"/"+i[0].FGBDT.substring(5,6)+"/"+i[0].FGBDT.substring(7,8));var o=a[r].Cdt01;if(i[0].FASEX=="1"&&i[0].FAMSA=="2"&&o>s&&i[0].yy_child_handica!="X"){t=true}}}var n=this.getOwnerComponent().getModel("FileReaderModel");var g=this.getOwnerComponent().getModel("buttonsModel");var d=this.getOwnerComponent().getModel("OriginalPdfFiles");var p=n.getProperty("/dataString");var v=n.getProperty("/dataStringDelay");var c=[];var u=[];var h=[];var f=this.getOwnerComponent().getModel("empItemData").getData();var m;var y=0;var M=this.getView().getModel("invoiceDate");var w=M.getData().invoiceDate;if(f.length>0){f.forEach(function(){if(f[y].Fasex=="1"&&f[y].Famsa=="2"&&f[y].Age>"30"&&f[y].Age<="30"){t=true}y=y+1});y=0;f.forEach(function(){var e=f[y].Fgbdt;var t=e.slice(0,4);var a=e.slice(4,6);var r=e.slice(6,8);var i=a.concat("/",r,"/",t);var s=new Date(i);var o=new Date(w);let n=s;let l=new Date(data);let g=l.getDate();let d=l.getMonth();let p=l.getfullYear();let v=o;let c=v.getFullYear()-p;let u=v.getMonth()-d;let h=v.getDate()-g;if(c==30&&u>0&&h>0){m=true}else if(c>30){m=true}else{m=false}onIncValue=onIncValue+1})}if(t==true||m==true){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.show("Child age is more than 30 years ,claim is not allowed",{icon:sap.m.MessageBox.Icon.ERROR,title:"Error",actions:[sap.m.MessageBox.Action.OK]});return}if(p){var b=n.getProperty("/size");b=b*1024;p=p.slice(28);var F={Linum:"001",Fsize:b.toString(),Fdata:p,Fista:"M"};c.push(F)}if(v){var b=n.getProperty("/sizeDelay");b=b*1024;v=v.slice(28);var F={Linum:"001",Fsize:b.toString(),Fdata:v,Fista:"A"};c.push(F)}var D=this.getView().getModel("OriginalPdfFiles").getProperty("/PDFFiles");var P=D.length;for(var r=0;r<P;r++){var T=D[r].size.toPrecision(3);var C=D[r].Type;if(C=="Approval"){var O="A"}else{O="M"}var F={Linum:"001",Fsize:T.toString(),Fdata:D[r].PDfData,Fista:O};c.push(F)}var A={Type:"E"};u.push(A);var I=g.getProperty("/process");var S=g.getProperty("/claimId");var B=g.getProperty("/prevPdf");var V=g.getProperty("/prevAppPdf");if(B==false){var R="X"}else{R=""}if(V==false){var _="X"}else{_=""}if(I==="Edit"){var z={Pernr:"",Refnr:S,FlagAttachDel:R,FlagAttDelApp:_,Rqamt:l.toString(),Apamt:"0",FlagSd:"X",TOItem:a,TOAttach:c,TOMessage_det:u}}else if(I==="Create"){var z={Pernr:"",Refnr:"",Rqamt:l.toString(),Apamt:"0",FlagSd:"X",TOItem:a,TOAttach:c,TOMessage_det:u}}this.finalCall(z)},onSubmit:function(){var e=this.getOwnerComponent().getModel("empFamDetails").getData();sap.ui.core.BusyIndicator.show(0);var t;var a=this.getOwnerComponent().getModel("detailMasterModel").getData();for(var i=0;i<a.length;i++){var s=e.filter(e=>e.TEXT.includes(a[i].Fcnam));if(s.length>0){var o=new Date((Number(s[0].FGBDT.substring(0,4))+30).toString()+"/"+s[0].FGBDT.substring(5,6)+"/"+s[0].FGBDT.substring(7,8));var n=a[i].Cdt01;if(s[0].FASEX=="1"&&s[0].FAMSA=="2"&&n>o&&s[0].yy_child_handica!="X"){t=true}}}if(t){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.show("Child age is more than 30 years ,claim is not allowed",{icon:sap.m.MessageBox.Icon.ERROR,title:"Error",actions:[sap.m.MessageBox.Action.OK]});return}else{var g=this.overallFileSize;if(g>5){r.error("Claim cannot be submitted as file size exceeds 5 MB");return}sap.ui.core.BusyIndicator.show(0);var a=this.getOwnerComponent().getModel("detailMasterModel").getData();var d=this.getOwnerComponent().getModel("FileReaderModel");var p=this.getOwnerComponent().getModel("buttonsModel");var v=this.getOwnerComponent().getModel("OriginalPdfFiles");var c=d.getProperty("/dataString");var u=d.getProperty("/dataStringDelay");var h=[];var f=[];var m=0;var y=0;if(c){var M=d.getProperty("/size");M=M*1024;c=c.slice(28);var w={Linum:"001",Fsize:M.toString(),Fdata:c,Fista:"M"};h.push(w);++m}if(u){var M=d.getProperty("/sizeDelay");M=M*1024;u=u.slice(28);var w={Linum:"001",Fsize:M.toString(),Fdata:u,Fista:"A"};h.push(w);++y}var b=this.getView().getModel("OriginalPdfFiles").getProperty("/PDFFiles");var F=b.length;for(var i=0;i<F;i++){var D=b[i].size.toPrecision(3);var P=b[i].Type;if(P=="Approval"){var T="A";++y}else{T="M";++m}var w={Linum:"001",Fsize:D.toString(),Fdata:b[i].PDfData,Fista:T};h.push(w)}var C={Type:"E"};f.push(C);var O=p.getProperty("/process");var A=p.getProperty("/claimId");var I=p.getProperty("/prevPdf");var S=p.getProperty("/prevAppPdf");var B=p.getProperty("/showDelayed");if(I==false){var V="X"}else{V=""}if(S==false){var R="X"}else{R=""}if(I==false&m==0){r.error("No Bills Attached!");sap.ui.core.BusyIndicator.hide();return}if(S==false&y==0&B==true){r.error("No Approval Attached!");sap.ui.core.BusyIndicator.hide();return}if(O==="Edit"){var _={Pernr:"",FlagAttachDel:V,FlagAttDelApp:R,Refnr:A,Rqamt:l.toString(),Apamt:"0",FlagSd:"",TOItem:a,TOAttach:h,TOMessage_det:f}}else if(O==="Create"){var _={Pernr:"",Refnr:"",Rqamt:l.toString(),Apamt:"0",FlagSd:"",TOItem:a,TOAttach:h,TOMessage_det:f}}this.RequestBody=_;if(this._TCDialog===null||typeof this._TCDialog===undefined){this._TCDialog=sap.ui.xmlfragment("Gail.Medical_Claim.view.TermsAndCondition",this)}this._TCDialog.open();var z=sap.ui.getCore().byId("FirstCheckBox");var E=sap.ui.getCore().byId("btnContinue");z.setSelected(false);E.setVisible(false)}},onTCDialog:function(e){sap.ui.core.BusyIndicator.hide();this._TCDialog.close()},onContinue:function(e){this._TCDialog.close();this.finalCall(this.RequestBody)},checkBoxEventHandler:function(e){var t=sap.ui.getCore().byId("FirstCheckBox");var a=sap.ui.getCore().byId("btnContinue");if(t.getSelected())a.setVisible(true);else a.setVisible(false)},finalCall:function(e){var t=this.getOwnerComponent().getModel("InitialModel");var a=this;t.create("/CLAIMS_DETAILSSet",e,{success:function(e){sap.ui.core.BusyIndicator.hide();var t=e.TOMessage_det.results.length;var i=false;var s="";for(var o=0;o<t;o++){s=e.TOMessage_det.results[o].Type;if("E"===s){i=true;e.TOMessage_det.results[o].Type="Error"}if("I"===s)e.TOMessage_det.results[o].Type="Information";if("W"===s)e.TOMessage_det.results[o].Type="Warning";if("S"===s)e.TOMessage_det.results[o].Type="Success"}if(i){a.getView().byId("errorBtn").setVisible(true);a.getView().byId("errorBtn").setText(e.TOMessage_det.results.length);var n=a.getOwnerComponent().getModel("ErrorMessages");n.setData(e.TOMessage_det.results);v.setModel(n);r.alert("Error Occured while submitting claim!",{title:"Error!"})}else{var l=e.TOMessage_det.results[0].Message;r.success(l,{title:"Success!",actions:[r.Action.OK],onClose:function(e){a.navtoInitial()}})}},error:function(e){sap.ui.core.BusyIndicator.hide();if(!e.TOMessage_det){r.error(e.message+" :"+e.statusCode)}else{var t=e.TOMessage_det.results[0].Message;r.error(t)}}})},handleMessagePopoverPress:function(e){v.toggle(e.getSource())}})});
//# sourceMappingURL=Review-dbg.controller.js.map